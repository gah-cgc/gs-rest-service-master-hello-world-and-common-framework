#!/bin/bash

echo "############################################"
echo "## Begin ETP Custom Pre-Build Step: assemble"
echo "##"

# Setup environment variables
DEFAULT_DIR=$(pwd)
REAL_SCRIPT_DIR=/usr/local/s2i
MVN_CMDLINE="mvn -B -U versions:use-latest-versions -DallowSnapshots=false -DfailIfNotReplaced=true -Dincludes=com.capgroup.equitytrading"
source ${REAL_SCRIPT_DIR}/s2i-setup

# Print environment variables
echo "CURR_DIR=$DEFAULT_DIR"
echo "S2I_SOURCE_DIR=$S2I_SOURCE_DIR"
echo "REAL_SCRIPT_DIR=$REAL_SCRIPT_DIR"

# Run pre-build step with Maven
pwd
cd ${S2I_SOURCE_DIR}
pwd
mvn -v
echo "Running command: $MVN_CMDLINE"
${MVN_CMDLINE}

echo "Changes made to pom.xml:"
diff pom.xml pom.xml.versionsBackup

# Proceed to the platform provided build process
cd ${DEFAULT_DIR}
${REAL_SCRIPT_DIR}/assemble

echo "##"
echo "## End ETP Custom Pre-Build Step: assemble"
echo "############################################"
